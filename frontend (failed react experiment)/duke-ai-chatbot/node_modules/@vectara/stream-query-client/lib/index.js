"use strict";var R=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var _=(e,t)=>{for(var r in t)R(e,r,{get:t[r],enumerable:!0})},w=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of v(t))!U.call(e,s)&&s!==r&&R(e,s,{get:()=>t[s],enumerable:!(a=E(t,s))||a.enumerable});return e};var M=e=>w(R({},"__esModule",{value:!0}),e);var Q={};_(Q,{streamQuery:()=>q});module.exports=M(Q);var u="%START_SNIPPET%",d="%END_SNIPPET%";var k=e=>{if(!e)return;let t=[],{response:r,document:a}=e;return r.forEach(s=>{let{documentIndex:i,text:x}=s,{pre:I,post:m,text:c}=G(x),p=a[Number(i)],{id:l,metadata:y}=p,{source:S,url:g,title:h,metadata:n}=z(y);t.push({id:l,snippet:{pre:I,text:c,post:m},source:S,url:g,title:h,metadata:n})}),t},z=e=>{let t=L(e);return{source:t.source,url:t.url,title:t.title||"Untitled",metadata:t}},G=e=>{let[t,r]=e.indexOf(u)!==-1?e.split(u):["",e],[a,s]=r.indexOf(d)!==-1?r.split(d):[r,""];return{pre:t,post:s,text:a}},L=e=>{let t={};return e.forEach(r=>{t[r.name]=r.value}),t};var O="api.vectara.io",q=async(e,t)=>{var c,p,l,y,S,g,h;let r={"x-api-key":e.apiKey,"customer-id":e.customerId,"Content-Type":"application/json"},a=(c=e.lambda)!=null?c:.025;a>1?a=1:a<0&&(a=0);let s=e.corpusIds.map(n=>({customerId:e.customerId,corpusId:n,lexicalInterpolationConfig:{lambda:a},metadataFilter:e.filter?`doc.source = '${e.filter}'`:void 0})),i=e.rerank?{rerankingConfig:{rerankerId:e.rerankerId,...e.rerankerId===272725718?{mmrConfig:{diversityBias:e.rerankDiversityBias}}:{}}}:{},x=JSON.stringify({query:[{query:e.queryValue,start:0,numResults:e.rerank?e.rerankNumResults:10,corpusKey:s,contextConfig:{sentencesBefore:(p=e.summaryNumSentences)!=null?p:2,sentencesAfter:(l=e.summaryNumSentences)!=null?l:2,startTag:u,endTag:d},summary:[{responseLang:e.language,maxSummarizedResults:e.summaryNumResults,summarizerPromptName:e.summaryPromptName,chat:{store:(S=(y=e.chat)==null?void 0:y.store)!=null?S:!1,conversationId:(g=e.chat)==null?void 0:g.conversationId}}],...i}]}),I=await B(r,x,(h=e.endpoint)!=null?h:O),m="";for await(let n of I)try{n.split(`
`).filter(b=>b!=="").forEach(b=>{var f,N,D,P;let o=JSON.parse(b);if(!o.result)return;let T=K(o.result),A={references:(f=k(o.result.responseSet))!=null?f:null,detail:T?{type:"chat",data:T}:null,updatedText:j(o.result,m),isDone:(D=(N=o.result.summary)==null?void 0:N.done)!=null?D:!1};m=(P=A.updatedText)!=null?P:"",t(A)})}catch{}},K=e=>e.summary?{conversationId:e.summary.chat.conversationId,turnId:e.summary.chat.turnId}:null,j=(e,t)=>e.summary?`${t}${e.summary.text}`:null,B=async(e,t,r)=>{let a=await fetch(`https://${r}/v1/stream-query`,{method:"POST",headers:e,body:t});if(a.status!==200)throw new Error(a.status.toString());if(!a.body)throw new Error("Response body does not exist");return H(a.body)};async function*H(e){let t=e.getReader(),r=new TextDecoder;for(;;){let{value:a,done:s}=await t.read();if(s)break;yield r.decode(a,{stream:!0})}}
